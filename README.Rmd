The Dynamic-p Technique with lavaan
======================================================

```{r set-options, echo = FALSE, cache = FALSE}
options(width = 100)
```

First we'll load the data and open our first two packages.

```{r, warning = F, message = F}
library(readxl)
library(tidyverse)

d <- read_excel("Lindsey.xlsx")

glimpse(d)
```

Note how the data are in the long format. That is, although we have one participant, "Lindsey", her data are presented in 103 rows, each corresponding to a different calendar day. 

The variable for calendar days, `Date`, is descriptively useful, but cumbersome for formal statistical analysis. Here we'll want to augment the data slightly by adding a numeric `day` index, ranging from 0 to 102.

```{r}
d <-
  d %>% 
  mutate(day = 1:n()-1) %>% 
  select(day, everything())
```

## Descriptive statistics

If you wanted to get a sense of the distributions of the ADHD items, histograms might be handy.

```{r, fig.width = 8, fig.height = 3.5}
d %>% 
  select(A3:A17) %>% 
  gather(item, rating) %>% 
  
  ggplot(aes(x = rating)) +
  geom_histogram(binwidth = 1, fill = "chartreuse", color = "grey92", size = 1/5) +
  theme(panel.grid = element_blank()) +
  facet_wrap(~item, ncol = 4)
```

Happily, their distributions look reasonable. You can get a sense of their values over time with a sequentially-color-coded tile plot.

```{r, fig.width = 10, fig.height = 2.5, warning = F, message = F}
library(viridis)

d %>% 
  select(Date, A3:A17) %>% 
  gather(item, rating, -Date) %>%
  mutate(rating = factor(rating, levels = c(1:5)),
         item = factor(item, levels = c("A3", "A8", "A10", "A13", "A14", "A16", "A17"))) %>% 
  
  ggplot(aes(x = Date, y = item)) +
  geom_raster(aes(fill = rating)) +
  scale_fill_viridis(NULL, discrete = TRUE, option = "D",
                     guide = guide_legend(direction = "horizontal",
                                          nrow = 1)) +
  scale_x_datetime(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = NULL, y = NULL) +
  theme(panel.grid = element_blank(),
        axis.text.y = element_text(hjust = 0),
        axis.ticks.y = element_blank(),
        legend.position = "top")
```

And with the [psych package](https://cran.r-project.org/web/packages/psych/index.html), we can use the `describe()` function to get the typical descriptive statistics.

```{r, warning = F, message = F}
library(psych)

d %>% 
  select(A3:A17) %>% 
  describe()
```  

Recall that the items in the ASRS correspond to the 18 criterion A symptoms, with the first nine classified as Inattentive and the last nine as hyperactive/impulsive. For the sake of this example, we'll focus on Lindsey's hyperactive/impulsive symptoms, ASRS items 10, 13, 14, 16, and 17. The following code drops the other two, items 3 and 8.

```{r}
d <-
  d %>% 
  select(everything(), -A3, -A8)
```

## P-technique CFA

Here we open our primary statistical package, [lavaan](https://cran.r-project.org/web/packages/lavaan/index.html).

```{r, message = F, warning = F}
library(lavaan)
```

### 0-lag.

The simplest starting place is a p-technique factor analysis. Using this approach, data 

```{r}
CFA_0_lag <- '
H =~ NA*A10 + A13 + A14 + A16 + A17

# Standardize the variance
H ~~ 1*H
'
```

```{r}
fit.CFA_0_lag <- 
  cfa(CFA_0_lag, 
      data = d,
      estimator = "MLR",
      missing = "ML")
```

```{r}
summary(fit.CFA_0_lag, 
        fit.measures = T)
```

### 1-lag.

Before we proceed to fit a dynamic-p CFA, we'll need to lag our data file. First, we'll add a row to the end of the data. Because this row corresponds to `Date = "2016-05-11"`, a day for which we don't have any information other than it was a Wednesday, we'll insert NAs into most of the columns.

```{r}
tail(d)

d_lagged <-
  d %>% 
  add_row(., day = 103, Date = "2016-05-11 00:00:00", 
          Mon = 0, Tues = 0, Wed = 1, Thur = 0, Fri = 0, Sat = 0, Sun = 0, 
          Meds = NA, 
          A10 = NA, A13 = NA, A14 = NA, A16 = NA, A17 = NA)
```

With the `lag()` function, we'll add lagged values for our `Meds` dummy and our ASRS items. For each of the lagged columns, we'll add the suffix `_1` to help differentiate them from the original columns.

```{r}
(
  d_lagged <-
  d_lagged %>% 
  mutate(Meds_1 = lag(Meds),
         A10_1  = lag(A10),
         A13_1  = lag(A13),
         A14_1  = lag(A14),
         A16_1  = lag(A16),
         A17_1  = lag(A17))
  )
```

Now we have our lagged data, `d_lagged`, we are ready to specify and fit the 1-lag CFA model.

```{r}
CFA_1_lag <- '
# Loadings
H0 =~ l1*A10 +   l2*A13 +   l3*A14 +   l4*A16 +   l5*A17
H1 =~ l1*A10_1 + l2*A13_1 + l3*A14_1 + l4*A16_1 + l5*A17_1

# LV variances
H0 ~~ 1*H0
H1 ~~ NA*H1 # Because of the structural model, the resitual variance for H1 is freely estimated

# residual variances
A10 ~~ rv1*A10
A13 ~~ rv2*A13
A14 ~~ rv3*A14
A16 ~~ rv4*A16
A17 ~~ rv5*A17

A10_1 ~~ rv1*A10_1
A13_1 ~~ rv2*A13_1
A14_1 ~~ rv3*A14_1
A16_1 ~~ rv4*A16_1
A17_1 ~~ rv5*A17_1

# item intercepts
A10 ~ i1*A10
A13 ~ i2*A13
A14 ~ i3*A14
A16 ~ i4*A16
A17 ~ i5*A17

A10_1 ~ i1*A10_1
A13_1 ~ i2*A13_1
A14_1 ~ i3*A14_1
A16_1 ~ i4*A16_1
A17_1 ~ i5*A17_1

# cross-lag residual covariances
A10 ~~ A10_1
A13 ~~ A13_1
A14 ~~ A14_1
A16 ~~ A16_1
A17 ~~ A17_1

# Structural model
H1 ~ H0
'
```

```{r}
fit.CFA_1_lag <- 
  cfa(CFA_1_lag, 
      data = d_lagged,
      estimator = "MLR",
      missing = "ML",
      std.lv = T)
```

```{r}
summary(fit.CFA_1_lag, 
        fit.measures = T)
```

## Dynamic-p SEM

Finally, we can use `Meds_1` to predict lag-1 ADHD values, `H1`, while still controlling for the previous day's ADHD values (i.e., `H1 ~ H0`).

```{r}
SEM_1_lag <- '
# Loadings
H0 =~ l1*A10 +   l2*A13 +   l3*A14 +   l4*A16 +   l5*A17
H1 =~ l1*A10_1 + l2*A13_1 + l3*A14_1 + l4*A16_1 + l5*A17_1

# LV variances
H0 ~~ 1*H0
H1 ~~ NA*H1 # Because of the structural model, the resitual variance for H1 is freely estimated

# residual variances
A10 ~~ rv1*A10
A13 ~~ rv2*A13
A14 ~~ rv3*A14
A16 ~~ rv4*A16
A17 ~~ rv5*A17

A10_1 ~~ rv1*A10_1
A13_1 ~~ rv2*A13_1
A14_1 ~~ rv3*A14_1
A16_1 ~~ rv4*A16_1
A17_1 ~~ rv5*A17_1

# item intercepts
A10 ~ i1*A10
A13 ~ i2*A13
A14 ~ i3*A14
A16 ~ i4*A16
A17 ~ i5*A17

A10_1 ~ i1*A10_1
A13_1 ~ i2*A13_1
A14_1 ~ i3*A14_1
A16_1 ~ i4*A16_1
A17_1 ~ i5*A17_1

# cross-lag residual covariances
A10 ~~ A10_1
A13 ~~ A13_1
A14 ~~ A14_1
A16 ~~ A16_1
A17 ~~ A17_1

# Structural model
H1 ~ H0 + Meds_1
'
```

```{r}
fit.SEM_1_lag <- 
  cfa(SEM_1_lag, 
      data = d_lagged,
      estimator = "MLR",
      missing = "ML",
      std.lv = T)
```

```{r}
summary(fit.SEM_1_lag, 
        fit.measures = T)
```

Recall that the latent variables are in a standardized metric. Because `Meds_1` is a dummy variable, this puts it's coefficient in a Cohen's $d$ like metric.